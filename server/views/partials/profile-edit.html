<article class="bg-signal-sidebar rounded-2xl shadow-xl border border-white/5 overflow-hidden animate-slide-up">
    <header class="p-6 border-b border-white/5 bg-gradient-to-b from-white/5 to-transparent">
        <h2 class="text-xl font-bold text-signal-text-main">Edit Profile</h2>
        <p class="text-sm text-signal-text-sub mt-1">Update your account information</p>
    </header>

    {{if .Error}}
        <div class="mx-6 mt-6 bg-red-500/10 border border-red-500/30 text-red-400 p-4 rounded-xl text-sm flex items-start gap-3 animate-shake">
            <svg class="w-5 h-5 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <p class="font-semibold mb-0.5">Error</p>
                <p class="text-red-300">{{.Error}}</p>
            </div>
        </div>
    {{end}}

    <form 
        hx-put="/profile" 
        hx-target="#profile-card" 
        hx-swap="innerHTML" 
        hx-indicator="#save-btn"
        hx-encoding="multipart/form-data"
        class="p-6 {{if .Error}}pt-4{{end}}">
        
        <!-- Profile Icon Selection -->
        <div class="mb-6">
            <label class="block text-signal-text-main text-sm font-semibold mb-3">Profile Icon</label>
            
            <!-- Current Icon Preview -->
            <div class="flex items-center gap-4 mb-4">
                <div id="current-icon-preview">
                    {{if .CustomIcon}}
                        <div class="w-20 h-20 rounded-full shadow-2xl ring-4 ring-signal-bg overflow-hidden">
                            <img src="{{.CustomIcon}}" alt="Profile" class="w-full h-full object-cover">
                        </div>
                    {{else}}
                        {{$iconClass := iconClass .Icon}}
                        {{$textColor := "text-white"}}
                        {{if eq .Icon "solid-dark"}}{{$textColor = "text-signal-text-main"}}{{end}}
                        
                        <div class="w-20 h-20 {{$iconClass}} rounded-full flex items-center justify-center text-3xl font-bold {{$textColor}} shadow-2xl ring-4 ring-signal-bg">
                            {{slice .Username 0 1}}
                        </div>
                    {{end}}
                </div>
                <div class="flex-1">
                    <p class="text-signal-text-main text-sm font-medium mb-1">Current Icon</p>
                    <p class="text-signal-text-sub text-xs">Choose from defaults or upload custom</p>
                </div>
            </div>

            <!-- Tab Buttons - Fixed with data attributes instead of onclick -->
            <div class="flex gap-2 mb-4 bg-signal-surface/50 p-1 rounded-xl">
                <button 
                    type="button" 
                    id="default-tab-btn" 
                    data-tab="default"
                    class="tab-button active flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all text-signal-text-main bg-signal-blue">
                    Default Icons
                </button>
                <button 
                    type="button" 
                    id="custom-tab-btn" 
                    data-tab="custom"
                    class="tab-button flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all text-signal-text-sub hover:text-signal-text-main">
                    Upload Custom
                </button>
            </div>

            <!-- Default Icons Grid -->
            <div id="default-icons-panel" class="tab-panel">
                <div class="grid grid-cols-5 gap-3 mb-4">
                    <!-- Gradient Icons -->
                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-blue" class="hidden peer" {{if eq .Icon "gradient-blue"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-purple" class="hidden peer" {{if eq .Icon "gradient-purple"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-green" class="hidden peer" {{if eq .Icon "gradient-green"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-orange" class="hidden peer" {{if eq .Icon "gradient-orange"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-orange-500 to-red-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-cyan" class="hidden peer" {{if eq .Icon "gradient-cyan"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-rose" class="hidden peer" {{if eq .Icon "gradient-rose"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-rose-500 to-pink-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-indigo" class="hidden peer" {{if eq .Icon "gradient-indigo"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-amber" class="hidden peer" {{if eq .Icon "gradient-amber"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-teal" class="hidden peer" {{if eq .Icon "gradient-teal"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-teal-500 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="gradient-slate" class="hidden peer" {{if eq .Icon "gradient-slate"}}checked{{end}}>
                        <div class="w-14 h-14 bg-gradient-to-br from-slate-600 to-gray-700 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <!-- Solid Colors -->
                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="solid-signal" class="hidden peer" {{if eq .Icon "solid-signal"}}checked{{end}}>
                        <div class="w-14 h-14 bg-signal-blue rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="solid-dark" class="hidden peer" {{if eq .Icon "solid-dark"}}checked{{end}}>
                        <div class="w-14 h-14 bg-signal-surface rounded-full flex items-center justify-center text-signal-text-main font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent border border-white/10 peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="solid-red" class="hidden peer" {{if eq .Icon "solid-red"}}checked{{end}}>
                        <div class="w-14 h-14 bg-red-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="solid-emerald" class="hidden peer" {{if eq .Icon "solid-emerald"}}checked{{end}}>
                        <div class="w-14 h-14 bg-emerald-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>

                    <label class="cursor-pointer group">
                        <input type="radio" name="icon" value="solid-violet" class="hidden peer" {{if eq .Icon "solid-violet"}}checked{{end}}>
                        <div class="w-14 h-14 bg-violet-600 rounded-full flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition-transform ring-2 ring-transparent peer-checked:ring-signal-blue peer-checked:ring-4">
                            {{slice .Username 0 1}}
                        </div>
                    </label>
                </div>
            </div>

            <!-- Custom Upload Section -->
            <div id="custom-upload-panel" class="tab-panel hidden">
                <div class="bg-signal-surface/50 rounded-xl p-6 border-2 border-dashed border-white/10 hover:border-signal-blue/50 transition-colors mb-4">
                    <input type="file" name="custom_icon" id="custom-icon-upload" accept="image/*" class="hidden">
                    <label for="custom-icon-upload" class="cursor-pointer flex flex-col items-center gap-3">
                        <div class="w-16 h-16 bg-signal-surface rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-signal-text-sub" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="text-center">
                            <p class="text-signal-text-main font-medium mb-1" id="upload-label">Click to upload</p>
                            <p class="text-signal-text-sub text-xs">PNG, JPG up to 5MB</p>
                        </div>
                    </label>
                </div>
                <p class="text-signal-text-sub text-xs text-center">Custom icons will be displayed across all your chats</p>
            </div>
        </div>

        <!-- Username Field -->
        <div class="mb-6">
            <label class="block text-signal-text-main text-sm font-semibold mb-2">Username</label>
            <input 
                type="text" 
                name="username" 
                value="{{.Username}}" 
                required
                autocomplete="off"
                class="w-full bg-signal-surface border border-white/10 rounded-xl px-4 py-3 text-signal-text-main placeholder-signal-text-sub focus:outline-none focus:border-signal-blue focus:ring-2 focus:ring-signal-blue/20 transition-all">
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 items-center pt-4 border-t border-white/5">
            <button 
                type="submit" 
                id="save-btn" 
                class="relative overflow-hidden {{if .Saved}}bg-green-600 hover:bg-green-700 pl-12 pr-6{{else}}bg-signal-blue hover:bg-signal-bluehover px-6{{end}} text-white font-semibold py-2.5 rounded-full transition-all duration-300 min-w-[160px] shadow-lg hover:shadow-blue-900/30">
                
                <div id="spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center bg-signal-blue rounded-full {{if .Saved}}hidden{{end}}">
                    <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                </div>

                <div id="checkmark" class="absolute left-5 top-1/2 -translate-y-1/2 text-xl font-bold {{if not .Saved}}hidden{{end}}">âœ“</div>

                <span id="button-text" class="relative">
                    {{if .Saved}}Saved!{{else}}Save Changes{{end}}
                </span>
            </button>
            
            <button 
                type="button" 
                class="bg-signal-surface hover:bg-signal-hover text-signal-text-main font-semibold py-2.5 px-6 rounded-full transition-all" 
                hx-get="/profile" 
                hx-target="#profile-card"
                hx-swap="innerHTML"> 
                Cancel
            </button>
        </div>
    </form>
</article>

<script>
(function() {
    // Tab switching using event delegation
    const tabButtons = document.querySelectorAll('[data-tab]');
    const defaultPanel = document.getElementById('default-icons-panel');
    const customPanel = document.getElementById('custom-upload-panel');
    const defaultBtn = document.getElementById('default-tab-btn');
    const customBtn = document.getElementById('custom-tab-btn');
    const fileInput = document.getElementById('custom-icon-upload');
    const uploadLabel = document.getElementById('upload-label');
    
    tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            
            if (tab === 'default') {
                defaultPanel.classList.remove('hidden');
                customPanel.classList.add('hidden');
                defaultBtn.classList.add('active', 'bg-signal-blue', 'text-signal-text-main');
                defaultBtn.classList.remove('text-signal-text-sub');
                customBtn.classList.remove('active', 'bg-signal-blue', 'text-signal-text-main');
                customBtn.classList.add('text-signal-text-sub');
                
                // Clear file input
                fileInput.value = '';
                uploadLabel.textContent = 'Click to upload';
            } else {
                defaultPanel.classList.add('hidden');
                customPanel.classList.remove('hidden');
                customBtn.classList.add('active', 'bg-signal-blue', 'text-signal-text-main');
                customBtn.classList.remove('text-signal-text-sub');
                defaultBtn.classList.remove('active', 'bg-signal-blue', 'text-signal-text-main');
                defaultBtn.classList.add('text-signal-text-sub');
                
                // Clear icon selection
                document.querySelectorAll('input[name="icon"]').forEach(radio => radio.checked = false);
            }
        });
    });
    
    // File selection handler
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            uploadLabel.textContent = file.name;
            
            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('current-icon-preview');
                preview.innerHTML = '<div class="w-20 h-20 rounded-full shadow-2xl ring-4 ring-signal-bg overflow-hidden"><img src="' + e.target.result + '" alt="Preview" class="w-full h-full object-cover"></div>';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Icon preview update for radio buttons
    document.querySelectorAll('input[name="icon"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const iconValue = this.value;
            const username = document.querySelector('input[name="username"]').value;
            const initial = username.charAt(0).toUpperCase();
            
            const iconClasses = {
                'gradient-blue': 'bg-gradient-to-br from-blue-500 to-blue-700',
                'gradient-purple': 'bg-gradient-to-br from-purple-500 to-pink-600',
                'gradient-green': 'bg-gradient-to-br from-green-500 to-emerald-600',
                'gradient-orange': 'bg-gradient-to-br from-orange-500 to-red-600',
                'gradient-cyan': 'bg-gradient-to-br from-cyan-500 to-blue-600',
                'gradient-rose': 'bg-gradient-to-br from-rose-500 to-pink-600',
                'gradient-indigo': 'bg-gradient-to-br from-indigo-500 to-purple-600',
                'gradient-amber': 'bg-gradient-to-br from-amber-500 to-orange-600',
                'gradient-teal': 'bg-gradient-to-br from-teal-500 to-green-600',
                'gradient-slate': 'bg-gradient-to-br from-slate-600 to-gray-700',
                'solid-signal': 'bg-signal-blue',
                'solid-dark': 'bg-signal-surface border border-white/10',
                'solid-red': 'bg-red-600',
                'solid-emerald': 'bg-emerald-600',
                'solid-violet': 'bg-violet-600'
            };
            
            const iconClass = iconClasses[iconValue] || 'bg-signal-surface';
            const textColor = iconValue === 'solid-dark' ? 'text-signal-text-main' : 'text-white';
            
            const preview = document.getElementById('current-icon-preview');
            preview.innerHTML = '<div class="w-20 h-20 ' + iconClass + ' rounded-full flex items-center justify-center text-3xl font-bold ' + textColor + ' shadow-2xl ring-4 ring-signal-bg">' + initial + '</div>';
        });
    });
})();
</script>

<style>
    .htmx-request #button-text { opacity: 0; }
    .htmx-request #spinner { display: flex !important; }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
        20%, 40%, 60%, 80% { transform: translateX(8px); }
    }
    .animate-shake { animation: shake 0.6s ease-in-out; }

    @keyframes slideUp {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
</style>