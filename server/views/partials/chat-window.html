<article class="flex flex-col h-full w-full relative bg-signal-bg">
    <header class="h-16 px-6 bg-signal-header border-b border-white/5 flex items-center justify-between z-10 sticky top-0 shrink-0">
        <div class="flex items-center gap-3 min-w-0">
            {{if .ContactCustomIcon}}
                <div class="w-10 h-10 rounded-full shadow-sm shrink-0 overflow-hidden ring-2 ring-white/5">
                    <img src="{{.ContactCustomIcon}}" alt="{{.Other}}" class="w-full h-full object-cover">
                </div>
            {{else}}
                <div class="w-10 h-10 {{iconClass .ContactIcon}} rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm shrink-0">
                    {{slice .Other 0 1}}
                </div>
            {{end}}
            
            <div class="flex flex-col min-w-0">
                <span class="text-signal-text-main font-semibold leading-tight truncate">{{.Other}}</span>
                <span class="text-xs text-signal-text-sub" id="connection-status">Connected</span>
            </div>
        </div>
        
        <div class="flex gap-4 text-signal-text-sub shrink-0">
            <button class="hover:text-signal-text-main transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
            <button class="hover:text-signal-text-main transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
            </button>
        </div>
    </header>

    <div id="scroll-wrapper" class="flex-1 overflow-y-auto px-4 py-6 custom-scrollbar">
        <div class="flex flex-col justify-end min-h-full">
            <div class="text-center mb-4 shrink-0">
                <span class="text-xs text-signal-text-sub bg-signal-surface/50 px-3 py-1 rounded-full border border-white/5">Today</span>
            </div>
            
            <div id="message-list" class="flex flex-col gap-1">
                {{$me := .Me}}
                {{range .Messages}}
                    <div class="flex w-full mb-1 group {{if eq .FromID $me}}justify-end{{else}}justify-start{{end}}" data-message-id="{{.MessageID}}">
                        <div class="max-w-[85%] md:max-w-[60%] lg:max-w-[500px] px-4 py-2 text-[15px] leading-relaxed shadow-sm relative {{if eq .FromID $me}}bg-signal-blue text-white rounded-2xl rounded-tr-sm{{else}}bg-signal-bubble text-signal-text-main rounded-2xl rounded-tl-sm{{end}}" style="word-break: break-word; overflow-wrap: break-word;">
                            {{.Content}}
                            <div class="text-[10px] opacity-60 text-right mt-1 select-none {{if eq .FromID $me}}text-blue-100{{else}}text-signal-text-sub{{end}}">
                                {{if eq .Timestamp 0}}Now{{else}}{{formatTime .Timestamp}}{{end}}
                            </div>
                        </div>
                    </div>
                {{end}}
            </div>
        </div>
    </div>

    <footer class="p-4 bg-signal-bg shrink-0">
        <form 
            id="chat-form"
            hx-post="/chat/{{.Other}}" 
            hx-trigger="submit"
            hx-swap="none"
            class="flex items-end gap-2 m-0 relative">
            
            {{if .CSRFToken}}
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            {{else}}
                <!-- ERROR: CSRFToken is empty in chat window! -->
            {{end}}

            <button type="button" class="p-3 text-signal-text-sub hover:text-signal-text-main transition-colors rounded-full hover:bg-signal-surface mb-0.5 shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            </button>

            <div class="flex-1 bg-signal-surface rounded-[24px] flex items-center px-4 py-2 border border-transparent focus-within:border-signal-text-sub/30 transition-all min-w-0">
                <input 
                    id="chat-input"
                    type="text" 
                    name="content" 
                    placeholder="Signal message" 
                    required 
                    autocomplete="off" 
                    class="w-full bg-transparent text-signal-text-main placeholder-signal-text-sub/70 focus:outline-none py-1.5">
            </div>
            
            <button 
                type="submit"
                class="p-3 bg-signal-blue hover:bg-signal-bluehover text-white rounded-full transition-all shadow-lg hover:shadow-blue-900/30 mb-0.5 group shrink-0">
                <svg class="w-5 h-5 transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </form>
        
        <script>
            (function() {
                const form = document.getElementById('chat-form');
                const input = document.getElementById('chat-input');
                const scrollWrapper = document.getElementById('scroll-wrapper');
                const messageList = document.getElementById('message-list');
                const statusEl = document.getElementById('connection-status');
                const contactName = '{{.Other}}';
                
                let eventSource = null;
                let reconnectAttempts = 0;
                const maxReconnectAttempts = 10;
                
                // Get last message ID
                function getLastMessageId() {
                    const messages = messageList.querySelectorAll('[data-message-id]');
                    if (messages.length > 0) {
                        return messages[messages.length - 1].dataset.messageId;
                    }
                    return '';
                }
                
                // Scroll to bottom
                function scrollToBottom() {
                    setTimeout(() => {
                        scrollWrapper.scrollTop = scrollWrapper.scrollHeight;
                    }, 50);
                }
                
                // Update connection status
                function updateStatus(status, color = 'text-signal-text-sub') {
                    if (statusEl) {
                        statusEl.textContent = status;
                        statusEl.className = 'text-xs ' + color;
                    }
                }
                
                // Connect to SSE
                function connectSSE() {
                    if (eventSource) {
                        eventSource.close();
                    }
                    
                    const lastMessageId = getLastMessageId();
                    const url = '/sse/' + contactName + (lastMessageId ? '?lastMessageId=' + lastMessageId : '');
                    
                    console.log('SSE: Connecting...', lastMessageId ? 'with last message: ' + lastMessageId : 'fresh connection');
                    updateStatus('Connecting...', 'text-yellow-500');
                    
                    eventSource = new EventSource(url);
                    
                    eventSource.addEventListener('connected', function(e) {
                        console.log('SSE: Connected', e.data);
                        updateStatus('Connected', 'text-green-500');
                        reconnectAttempts = 0;
                    });
                    
                    eventSource.addEventListener('message', function(e) {
                        console.log('SSE: Message received');
                        messageList.insertAdjacentHTML('beforeend', e.data);
                        scrollToBottom();
                    });
                    
                    eventSource.addEventListener('ping', function(e) {
                        console.log('SSE: Keepalive ping');
                    });
                    
                    eventSource.onerror = function(e) {
                        console.error('SSE: Connection error', e);
                        updateStatus('Reconnecting...', 'text-yellow-500');
                        
                        eventSource.close();
                        
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                            console.log(`SSE: Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                            setTimeout(connectSSE, delay);
                        } else {
                            updateStatus('Disconnected', 'text-red-500');
                            console.error('SSE: Max reconnection attempts reached');
                        }
                    };
                }
                
                // Handle form submission
                form.addEventListener('htmx:afterRequest', function(evt) {
                    if (evt.detail.successful) {
                        form.reset();
                        input.focus();
                    }
                });
                
                // Initialize
                scrollToBottom();
                connectSSE();
                
                // Cleanup on page unload
                window.addEventListener('beforeunload', function() {
                    if (eventSource) {
                        eventSource.close();
                    }
                });
            })();
        </script>
    </footer>
</article>