<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{if .CSRFToken}}
    <meta name="csrf-token" content="{{.CSRFToken}}">
    {{end}}
    <title>{{.Group.Name}} - SecureChat</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/scripts/js/htmx-csrf.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        signal: {
                            bg: '#121212',          
                            sidebar: '#181818',     
                            header: '#1E1E1E',      
                            surface: '#2C2C2C',     
                            hover: '#333333',       
                            blue: '#2C6BED',        
                            bluehover: '#3876F3',
                            bubble: '#303030',      
                            text: {
                                main: '#F2F2F2',
                                sub: '#848586',
                            }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #333;
            border-radius: 4px;
            border: 2px solid #181818;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #4a4a4a;
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #333 transparent;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body class="h-screen w-screen m-0 overflow-hidden bg-signal-bg text-signal-text-main font-sans">

    <div class="flex h-full w-full">
        
        <!-- Sidebar with group info -->
        <aside class="w-[320px] bg-signal-sidebar flex flex-col shrink-0 border-r border-white/5 z-20">
            <div class="h-16 px-4 bg-signal-sidebar flex items-center gap-3 shrink-0 border-b border-white/5">
                <a href="/dashboard" class="hover:bg-signal-surface p-2 rounded-full transition-colors">
                    <svg class="w-5 h-5 text-signal-text-sub" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                
                {{if .Group.CustomIcon}}
                <img src="{{.Group.CustomIcon}}" class="w-10 h-10 rounded-full" alt="{{.Group.Name}}">
                {{else}}
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white font-bold text-lg">
                    {{slice .Group.Name 0 1}}
                </div>
                {{end}}
                
                <div class="flex-1 min-w-0">
                    <h2 class="font-semibold text-signal-text-main truncate">{{.Group.Name}}</h2>
                    <p class="text-xs text-signal-text-sub">{{.Group.MemberCount}} members</p>
                </div>
            </div>

            <!-- Group Members -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-signal-text-main uppercase">Members</h3>
                    {{if eq .Group.UserRole "admin"}}
                    <button onclick="document.getElementById('add-member-form').classList.toggle('hidden')" 
                            class="text-signal-blue hover:text-signal-bluehover">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    {{end}}
                </div>

                {{if eq .Group.UserRole "admin"}}
                <form id="add-member-form" class="hidden mb-4 bg-signal-surface rounded-lg p-3" 
                      hx-post="/groups/{{.Group.ID}}/members" 
                      hx-target="#members-list"
                      hx-swap="innerHTML">
                    <div class="flex gap-2">
                        <input type="text" name="username" placeholder="Username" required
                               class="flex-1 bg-signal-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-signal-text-main">
                        <button type="submit" class="px-3 py-2 bg-signal-blue hover:bg-signal-bluehover text-white rounded-lg text-sm">
                            Add
                        </button>
                    </div>
                </form>
                {{end}}

                <div id="members-list" hx-get="/groups/{{.Group.ID}}/members" hx-trigger="load" hx-swap="innerHTML">
                    <div class="text-signal-text-sub text-sm">Loading members...</div>
                </div>
            </div>

            <!-- Group Actions -->
            <div class="p-4 border-t border-white/5 space-y-2">
                {{if eq .Group.UserRole "admin"}}
                <button hx-delete="/groups/{{.Group.ID}}" 
                        hx-confirm="Delete this group? This cannot be undone."
                        class="w-full text-left px-3 py-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors text-sm">
                    Delete Group
                </button>
                {{else}}
                <button hx-delete="/groups/{{.Group.ID}}/members/{{.Username}}"
                        hx-confirm="Leave {{.Group.Name}}?"
                        class="w-full text-left px-3 py-2 text-signal-text-sub hover:bg-signal-surface rounded-lg transition-colors text-sm">
                    Leave Group
                </button>
                {{end}}
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-signal-bg h-full">
            
            <!-- Chat Header -->
            <header class="h-16 px-6 bg-signal-header border-b border-white/5 flex items-center justify-between z-10 shrink-0">
                <div class="flex items-center gap-3">
                    <h1 class="text-lg font-semibold text-signal-text-main">{{.Group.Name}}</h1>
                    {{if .Group.Description}}
                    <span class="text-sm text-signal-text-sub">â€¢ {{.Group.Description}}</span>
                    {{end}}
                </div>
                <div class="text-xs text-signal-text-sub" id="connection-status">Connected</div>
            </header>

            <!-- Messages -->
            <div id="scroll-wrapper" class="flex-1 overflow-y-auto px-4 py-6 custom-scrollbar">
                <div class="flex flex-col justify-end min-h-full">
                    <div class="text-center mb-4 shrink-0">
                        <span class="text-xs text-signal-text-sub bg-signal-surface/50 px-3 py-1 rounded-full border border-white/5">Today</span>
                    </div>
                    
                    <div id="message-list" class="flex flex-col gap-1">
                        {{range .Messages}}
                        <div class="flex w-full mb-1 group {{if eq .FromID $.Username}}justify-end{{else}}justify-start{{end}}" data-message-id="{{.MessageID}}">
                            <div class="max-w-[85%] md:max-w-[60%] lg:max-w-[500px] px-4 py-2 text-[15px] leading-relaxed shadow-sm relative {{if eq .FromID $.Username}}bg-signal-blue text-white rounded-2xl rounded-tr-sm{{else}}bg-signal-bubble text-signal-text-main rounded-2xl rounded-tl-sm{{end}}" style="word-break: break-word; overflow-wrap: break-word;">
                                {{if ne .FromID $.Username}}
                                <div class="text-xs font-semibold text-signal-blue mb-1">{{.FromID}}</div>
                                {{end}}
                                {{.Content}}
                                <div class="text-[10px] opacity-60 text-right mt-1 select-none {{if eq .FromID $.Username}}text-blue-100{{else}}text-signal-text-sub{{end}}">Now</div>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <footer class="p-4 bg-signal-bg shrink-0">
                <form id="chat-form" hx-post="/groups/{{.Group.ID}}/send" hx-trigger="submit" hx-swap="none" class="flex items-end gap-2">
                    {{if .CSRFToken}}
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    {{end}}

                    <div class="flex-1 bg-signal-surface rounded-[24px] flex items-center px-4 py-2 border border-transparent focus-within:border-signal-text-sub/30 transition-all">
                        <input id="chat-input" type="text" name="content" placeholder="Message {{.Group.Name}}" required autocomplete="off"
                               class="w-full bg-transparent text-signal-text-main placeholder-signal-text-sub/70 focus:outline-none py-1.5">
                    </div>
                    
                    <button type="submit" class="p-3 bg-signal-blue hover:bg-signal-bluehover text-white rounded-full transition-all shadow-lg hover:shadow-blue-900/30 group shrink-0">
                        <svg class="w-5 h-5 transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                        </svg>
                    </button>
                </form>
            </footer>

        </main>
    </div>

    <script>
        (function() {
            const groupId = '{{.Group.ID}}';
            const username = '{{.Username}}';
            const form = document.getElementById('chat-form');
            const input = document.getElementById('chat-input');
            const scrollWrapper = document.getElementById('scroll-wrapper');
            const messageList = document.getElementById('message-list');
            const statusEl = document.getElementById('connection-status');
            
            let eventSource = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 10;
            
            function getLastMessageId() {
                const messages = messageList.querySelectorAll('[data-message-id]');
                if (messages.length > 0) {
                    return messages[messages.length - 1].dataset.messageId;
                }
                return '';
            }
            
            function scrollToBottom() {
                setTimeout(() => {
                    scrollWrapper.scrollTop = scrollWrapper.scrollHeight;
                }, 50);
            }
            
            function updateStatus(status, color = 'text-signal-text-sub') {
                if (statusEl) {
                    statusEl.textContent = status;
                    statusEl.className = 'text-xs ' + color;
                }
            }
            
            function connectSSE() {
                if (eventSource) {
                    eventSource.close();
                }
                
                const lastMessageId = getLastMessageId();
                const url = '/groups/' + groupId + '/sse' + (lastMessageId ? '?lastMessageId=' + lastMessageId : '');
                
                console.log('SSE: Connecting to group chat...', lastMessageId ? 'with last message: ' + lastMessageId : 'fresh connection');
                updateStatus('Connecting...', 'text-yellow-500');
                
                eventSource = new EventSource(url);
                
                eventSource.addEventListener('connected', function(e) {
                    console.log('SSE: Connected to group', e.data);
                    updateStatus('Connected', 'text-green-500');
                    reconnectAttempts = 0;
                });
                
                eventSource.addEventListener('message', function(e) {
                    console.log('SSE: Group message received');
                    messageList.insertAdjacentHTML('beforeend', e.data);
                    scrollToBottom();
                });
                
                eventSource.addEventListener('ping', function(e) {
                    console.log('SSE: Keepalive ping');
                });
                
                eventSource.onerror = function(e) {
                    console.error('SSE: Connection error', e);
                    updateStatus('Reconnecting...', 'text-yellow-500');
                    
                    eventSource.close();
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        console.log(`SSE: Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                        setTimeout(connectSSE, delay);
                    } else {
                        updateStatus('Disconnected', 'text-red-500');
                        console.error('SSE: Max reconnection attempts reached');
                    }
                };
            }
            
            // Handle form submission
            form.addEventListener('htmx:afterRequest', function(evt) {
                if (evt.detail.successful) {
                    form.reset();
                    input.focus();
                }
            });
            
            // Initialize
            scrollToBottom();
            connectSSE();
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', function() {
                if (eventSource) {
                    eventSource.close();
                }
            });
        })();
    </script>

</body>
</html>