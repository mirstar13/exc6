<article class="flex h-full w-full relative">
    <input type="checkbox" id="group-info-toggle" class="hidden peer" autocomplete="off">

    <aside id="group-sidebar" class="w-0 overflow-hidden peer-checked:w-[280px] bg-signal-sidebar flex flex-col shrink-0 border-r border-white/5 transition-all duration-300 opacity-0 -translate-x-4">
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center gap-3 mb-4">
                {{if .Group.CustomIcon}}
                <img src="{{.Group.CustomIcon}}" class="w-12 h-12 rounded-full" alt="{{.Group.Name}}">
                {{else}}
                <div class="w-12 h-12 {{iconClass .Group.Icon}} rounded-full flex items-center justify-center text-white font-bold text-lg">
                    {{slice .Group.Name 0 1}}
                </div>
                {{end}}
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-signal-text-main truncate">{{.Group.Name}}</h3>
                    <p class="text-xs text-signal-text-sub">{{.Group.MemberCount}} members</p>
                </div>
            </div>
            {{if .Group.Description}}
            <p class="text-sm text-signal-text-sub">{{.Group.Description}}</p>
            {{end}}
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-xs font-semibold text-signal-text-sub uppercase">Members</h4>
                <button onclick="openGroupManageModal()" 
                        class="text-signal-blue hover:text-signal-bluehover transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
            <div id="members-list" class="space-y-2">
                </div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col bg-signal-bg h-full">
        <header id="group-header" class="h-16 px-6 bg-signal-header border-b border-white/5 flex items-center justify-between z-10 shrink-0 opacity-0 -translate-y-2">
            <div class="flex items-center gap-3">
                <label for="group-info-toggle" class="p-2 hover:bg-signal-surface rounded-lg transition-colors cursor-pointer select-none">
                    <svg class="w-5 h-5 text-signal-text-sub" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </label>
                <h1 class="text-lg font-semibold text-signal-text-main">{{.Group.Name}}</h1>
            </div>
            <div class="text-xs text-signal-text-sub" id="connection-status">Connected</div>
        </header>

        <div id="scroll-wrapper" class="flex-1 overflow-y-auto px-4 py-6 custom-scrollbar">
            <div class="flex flex-col justify-end min-h-full">
                <div class="text-center mb-4 shrink-0">
                    <span class="text-xs text-signal-text-sub bg-signal-surface/50 px-3 py-1 rounded-full border border-white/5">Today</span>
                </div>
                
                <div id="message-list" class="flex flex-col">
                    {{$me := .Username}}
                    {{$prevSender := ""}}
                    {{range $index, $msg := .Messages}}
                        {{$isMe := eq $msg.FromID $me}}
                        {{$showAvatar := ne $msg.FromID $prevSender}}
                        
                        {{if $isMe}}
                            <div class="message-bubble flex w-full justify-end {{if $showAvatar}}mt-3{{else}}mt-0.5{{end}} opacity-0 translate-y-2" data-message-id="{{$msg.MessageID}}">
                                <div class="max-w-[85%] md:max-w-[60%] lg:max-w-[500px] px-4 py-2 text-[15px] leading-relaxed shadow-sm relative bg-signal-blue text-white {{if $showAvatar}}rounded-2xl rounded-tr-sm{{else}}rounded-xl{{end}}" style="word-break: break-word; overflow-wrap: break-word;">
                                    {{$msg.Content}}
                                    <div class="text-[10px] opacity-60 text-right mt-1 select-none text-blue-100">{{if eq $msg.Timestamp 0}}Now{{else}}{{formatTime $msg.Timestamp}}{{end}}</div>
                                </div>
                            </div>
                        {{else}}
                            <div class="message-bubble flex w-full justify-start {{if $showAvatar}}mt-3{{else}}mt-0.5{{end}} opacity-0 translate-y-2" data-message-id="{{$msg.MessageID}}">
                                <div class="flex items-start gap-2 max-w-[85%] md:max-w-[60%] lg:max-w-[500px]">
                                    {{if $showAvatar}}
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white font-bold text-xs shrink-0">
                                        {{slice $msg.FromID 0 1}}
                                    </div>
                                    {{else}}
                                    <div class="w-8 h-8 shrink-0"></div>
                                    {{end}}
                                    
                                    <div class="flex-1 min-w-0">
                                        {{if $showAvatar}}
                                        <div class="text-xs font-semibold text-signal-blue mb-0.5">{{$msg.FromID}}</div>
                                        {{end}}
                                        <div class="px-4 py-2 text-[15px] leading-relaxed shadow-sm relative bg-signal-bubble text-signal-text-main {{if $showAvatar}}rounded-2xl rounded-tl-sm{{else}}rounded-xl{{end}}" style="word-break: break-word; overflow-wrap: break-word;">
                                            {{$msg.Content}}
                                            <div class="text-[10px] opacity-60 text-right mt-1 select-none text-signal-text-sub">{{if eq $msg.Timestamp 0}}Now{{else}}{{formatTime $msg.Timestamp}}{{end}}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {{end}}
                        
                        {{$prevSender = $msg.FromID}}
                    {{end}}
                </div>
            </div>
        </div>

        <footer id="group-footer" class="p-4 bg-signal-bg shrink-0 opacity-0 translate-y-2">
            <form id="chat-form" hx-post="/groups/{{.Group.ID}}/send" hx-trigger="submit" hx-swap="none" class="flex items-end gap-2">
                {{if .CSRFToken}}
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                {{end}}

                <div class="flex-1 bg-signal-surface rounded-[24px] flex items-center px-4 py-2 border border-transparent focus-within:border-signal-text-sub/30 transition-all">
                    <input id="chat-input" type="text" name="content" placeholder="Message {{.Group.Name}}" required autocomplete="off"
                           class="w-full bg-transparent text-signal-text-main placeholder-signal-text-sub/70 focus:outline-none py-1.5">
                </div>
                
                <button type="submit"
                        class="p-3 bg-signal-blue hover:bg-signal-bluehover text-white rounded-full transition-all shadow-lg hover:shadow-blue-900/30 group shrink-0">
                    <svg class="w-5 h-5 transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                    </svg>
                </button>
            </form>
        </footer>
    </div>

    <div id="group-manage-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-signal-surface rounded-2xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-signal-text-main">Manage Group</h3>
                <button onclick="closeGroupManageModal()" class="text-signal-text-sub hover:text-signal-text-main">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-6">
                <h4 class="text-sm font-semibold text-signal-text-main mb-3">Add Member</h4>
                <form hx-post="/groups/{{.Group.ID}}/members" 
                      hx-target="#members-list" 
                      hx-swap="innerHTML"
                      class="flex gap-2">
                    <input type="text" name="username" placeholder="Username" required
                           class="flex-1 bg-signal-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-signal-text-main focus:outline-none focus:border-signal-blue">
                    <button type="submit" class="px-4 py-2 bg-signal-blue hover:bg-signal-bluehover text-white rounded-lg text-sm transition-all">
                        Add
                    </button>
                </form>
            </div>

            <div>
                <h4 class="text-sm font-semibold text-signal-text-main mb-3">Members</h4>
                <div id="modal-members-list" 
                     hx-get="/groups/{{.Group.ID}}/members" 
                     hx-trigger="load"
                     hx-swap="innerHTML"
                     class="space-y-2">
                    Loading...
                </div>
            </div>

            {{if eq .Group.UserRole "admin"}}
            <div class="mt-6 pt-6 border-t border-white/5">
                <button hx-delete="/groups/{{.Group.ID}}" 
                        hx-confirm="Delete {{.Group.Name}}? This cannot be undone."
                        class="w-full text-left px-3 py-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors text-sm">
                    Delete Group
                </button>
            </div>
            {{end}}
        </div>
    </div>

    <script>
        (function() {
            const groupId = '{{.Group.ID}}';
            const username = '{{.Username}}';
            const form = document.getElementById('chat-form');
            const input = document.getElementById('chat-input');
            const scrollWrapper = document.getElementById('scroll-wrapper');
            const messageList = document.getElementById('message-list');
            
            if (window.anime) {
                const tl = anime.timeline({ easing: 'easeOutExpo' });

                tl.add({
                    targets: '#group-sidebar',
                    opacity: [0, 1],
                    translateX: [-20, 0],
                    duration: 600
                })
                .add({
                    targets: '#group-header',
                    translateY: [-10, 0],
                    opacity: [0, 1],
                    duration: 600
                }, '-=400')
                .add({
                    targets: '#group-footer',
                    translateY: [10, 0],
                    opacity: [0, 1],
                    duration: 600
                }, '-=400')
                .add({
                    targets: '.message-bubble',
                    translateY: [10, 0],
                    opacity: [0, 1],
                    delay: anime.stagger(20, {start: 100}),
                    duration: 400,
                    complete: () => scrollToBottom()
                }, '-=500');
            }
            
            let wsClient = null;
            let lastSender = null;
            
            function handleGroupMessage(message) {
                // Filter: Ignore messages for other groups
                if (message.group_id !== groupId) return;
                
                // Render message
                const messageHTML = renderMessage(message);
                
                // ... (keep existing animation/append logic) ...
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = messageHTML;
                const newMsg = tempDiv.firstElementChild;
                newMsg.classList.add('opacity-0', 'translate-y-2');
                
                messageList.appendChild(newMsg);
                
                if (window.anime) {
                    anime({
                        targets: newMsg,
                        opacity: [0, 1],
                        translateY: [10, 0],
                        easing: 'easeOutQuad',
                        duration: 300
                    });
                } else {
                    newMsg.classList.remove('opacity-0', 'translate-y-2');
                }

                scrollToBottom();
            }

            window.activeChatHandler = handleGroupMessage;

            function renderMessage(message) {
                const isMe = message.from === username;
                const content = escapeHTML(message.content);
                const timestamp = formatTime(message.timestamp);
                
                const showAvatar = message.from !== lastSender;
                lastSender = message.from;

                let html = '';

                if (isMe) {
                    html = `
                        <div class="flex w-full justify-end ${showAvatar ? 'mt-3' : 'mt-0.5'}" data-message-id="${message.id}">
                            <div class="max-w-[85%] md:max-w-[60%] lg:max-w-[500px] px-4 py-2 text-[15px] leading-relaxed shadow-sm relative bg-signal-blue text-white ${showAvatar ? 'rounded-2xl rounded-tr-sm' : 'rounded-xl'}" style="word-break: break-word; overflow-wrap: break-word;">
                                ${content}
                                <div class="text-[10px] opacity-60 text-right mt-1 select-none text-blue-100">${timestamp}</div>
                            </div>
                        </div>
                    `;
                } else {
                    const iconClass = getIconClass(message.data?.icon || 'gradient-blue');
                    const initial = message.from.charAt(0).toUpperCase();
                    const customIcon = message.data?.custom_icon;

                    html = `
                        <div class="flex w-full justify-start ${showAvatar ? 'mt-3' : 'mt-0.5'}" data-message-id="${message.id}">
                            <div class="flex items-start gap-2 max-w-[85%] md:max-w-[60%] lg:max-w-[500px]">
                                ${showAvatar ? `
                                    <div class="w-8 h-8 rounded-full ${customIcon ? 'overflow-hidden' : iconClass} flex items-center justify-center text-white font-bold text-xs shrink-0">
                                        ${customIcon ? `<img src="${customIcon}" class="w-full h-full object-cover">` : initial}
                                    </div>
                                ` : '<div class="w-8 h-8 shrink-0"></div>'}
                                
                                <div class="flex-1 min-w-0">
                                    ${showAvatar ? `<div class="text-xs font-semibold text-signal-blue mb-0.5">${message.from}</div>` : ''}
                                    <div class="px-4 py-2 text-[15px] leading-relaxed shadow-sm relative bg-signal-bubble text-signal-text-main ${showAvatar ? 'rounded-2xl rounded-tl-sm' : 'rounded-xl'}" style="word-break: break-word; overflow-wrap: break-word;">
                                        ${content}
                                        <div class="text-[10px] opacity-60 text-right mt-1 select-none text-signal-text-sub">${timestamp}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return html;
            }

            function getIconClass(icon) {
                 const iconClasses = {
                    "gradient-blue":   "bg-gradient-to-br from-blue-500 to-blue-700",
                    "gradient-purple": "bg-gradient-to-br from-purple-500 to-pink-600",
                    "gradient-green":  "bg-gradient-to-br from-green-500 to-emerald-600",
                    "gradient-orange": "bg-gradient-to-br from-orange-500 to-red-600",
                    "gradient-cyan":   "bg-gradient-to-br from-cyan-500 to-blue-600",
                    "gradient-rose":   "bg-gradient-to-br from-rose-500 to-pink-600",
                    "gradient-indigo": "bg-gradient-to-br from-indigo-500 to-purple-600",
                    "gradient-amber":  "bg-gradient-to-br from-amber-500 to-orange-600",
                    "gradient-teal":   "bg-gradient-to-br from-teal-500 to-green-600",
                    "gradient-slate":  "bg-gradient-to-br from-slate-600 to-gray-700",
                    "solid-signal":    "bg-signal-blue",
                    "solid-dark":      "bg-signal-surface border border-white/10",
                    "solid-red":       "bg-red-600",
                    "solid-emerald":   "bg-emerald-600",
                    "solid-violet":    "bg-violet-600",
                };
                return iconClasses[icon] || iconClasses["gradient-blue"];
            }

            function escapeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            function formatTime(timestamp) {
                if (!timestamp) return 'Now';
                const date = new Date(timestamp * 1000);
                const now = new Date();
                
                if (date.toDateString() === now.toDateString()) {
                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                }
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            function scrollToBottom() {
                setTimeout(() => {
                    scrollWrapper.scrollTop = scrollWrapper.scrollHeight;
                }, 50);
            }
            
            form.addEventListener('htmx:afterRequest', function(evt) {
                if (evt.detail.successful) {
                    form.reset();
                    input.focus();
                }
            });
            
            // Initialize last sender from existing DOM messages
            const messages = messageList.querySelectorAll('[data-message-id]');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                const isMyMessage = lastMessage.classList.contains('justify-end');
                
                if (isMyMessage) {
                    lastSender = username;
                } else {
                    const senderEl = lastMessage.querySelector('.text-signal-blue');
                    lastSender = senderEl ? senderEl.textContent : null;
                }
            }
            
            scrollToBottom();
            
            // Load members
            fetch('/groups/' + groupId + '/members')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('members-list').innerHTML = html;
                });
            
            window.addEventListener('beforeunload', function() {
                // Don't close the connection, just remove the handler
                if (window.activeChatHandler === handleGroupMessage) {
                    window.activeChatHandler = null;
                }
            });
        })();
        
        function openGroupManageModal() {
            const modal = document.getElementById('group-manage-modal');
            modal.classList.remove('hidden');
            if(window.anime) {
                anime({
                    targets: modal.querySelector('.modal-content'),
                    scale: [0.95, 1],
                    opacity: [0, 1],
                    duration: 250,
                    easing: 'easeOutQuad'
                });
            }
        }
        
        function closeGroupManageModal() {
            document.getElementById('group-manage-modal').classList.add('hidden');
        }
        
        document.getElementById('group-manage-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeGroupManageModal();
        });
    </script>
</article>